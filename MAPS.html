<script>
  var map = L.map('map').setView([33.0, -83.5], 7);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  var markers = []; // 마커를 저장할 배열

  // JSON 파일에서 데이터를 로드
  fetch('./locations.json') // JSON 파일 경로
    .then(response => {
      if (!response.ok) {
        throw new Error('Failed to fetch JSON');
      }
      return response.json();
    })
    .then(locations => {
      locations.forEach(function(location) {
        var customIcon = L.AwesomeMarkers.icon({
          extraClasses: 'fa-rotate-0',
          icon: 'info-sign',
          iconColor: 'white',
          markerColor: 'red',
          prefix: 'glyphicon'
        });

        var marker = L.marker([location.lat, location.lng], {icon: customIcon}).addTo(map);

        if (location.SOSlink) {
          // 마커: 팝업에 이름과 SOS 링크 표시
          marker.bindPopup(
            `${location.name}<br><a href="javascript:void(0)" onclick="navigateTo('${location.SOSlink}')" style="text-decoration: none; color: blue;">SOS</a>`
          );
        } else {
          // 다른 마커: 팝업에 이름만 표시
          marker.bindPopup(location.name);
        }

        // 생성한 마커를 배열에 추가
        markers.push(marker);
      });
    })
    .catch(error => console.error('Error loading JSON:', error));

  // 페이지 이동 함수 (현재 창에서 이동)
  function navigateTo(link) {
    window.location.assign(link); // 현재 창에서 이동
  }

  // 줌 이벤트에 따라 마커 표시 여부 제어
  map.on('zoomend', function() {
    var currentZoom = map.getZoom();
    var minZoomForMarkers = 10; // 마커가 표시되기 위한 최소 줌 레벨

    markers.forEach(marker => {
      if (currentZoom >= minZoomForMarkers) {
        map.addLayer(marker); // 마커 표시
      } else {
        map.removeLayer(marker); // 마커 숨김
      }
    });
  });

  // Add search control and keep it always open
  var geocoder = L.Control.geocoder({
    defaultMarkGeocode: false
  }).addTo(map);

  geocoder._toggle(); // Ensure the search bar is always expanded

  geocoder.on('markgeocode', function(e) {
    var bbox = e.geocode.bbox;
    var poly = L.polygon([
      bbox.getSouthEast(),
      bbox.getNorthEast(),
      bbox.getNorthWest(),
      bbox.getSouthWest()
    ]).addTo(map);
    map.fitBounds(poly.getBounds());
  });
</script>

