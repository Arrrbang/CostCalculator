<!DOCTYPE html>
<html>
<head>
  <title>Leaflet MAPS with Nominatim</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.css" />
  <!-- Leaflet Awesome Markers CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" />
  <!-- Bootstrap CSS for Glyphicons -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <!-- Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.js"></script>
  <!-- Leaflet Awesome Markers JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
  <style>
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
    }
    #header-space {
      height: 16.66%; /* 페이지의 1/6 */
      background-color: #f4f4f4; /* 공백 영역의 배경색 */
    }
    #map {
      flex: 1;
      height: auto;
    }
    #search-container {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      border-radius: 5px;
      z-index: 1000;
      display: flex;
      gap: 5px;
    }
    #search-input {
      width: 200px;
      padding: 5px;
    }
    #results {
      position: absolute;
      top: 50px;
      right: 10px;
      background: white;
      width: 220px;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      border-radius: 5px;
      z-index: 1000;
    }
    #results div {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
    }
    #results div:hover {
      background: #f0f0f0;
    }
  </style>
</head>
<body>
  <div id="header-space"></div> <!-- 페이지 상단 1/6 공백 -->
  <div id="search-container">
    <input type="text" id="search-input" placeholder="Search for a location" />
    <button id="search-button">Search</button>
  </div>
  <div id="results"></div>
  <div id="map"></div>
  <script>
    // 인증 확인: 토큰 검증
    function verifyToken() {
      const token = localStorage.getItem('token'); // 로컬 스토리지에서 토큰 가져오기
      if (!token) {
        alert('로그인이 해제되었습니다. 다시 로그인해주세요.');
        window.location.href = 'index.html'; // 로그인 페이지로 리다이렉션
        return;
      }

      // 토큰 유효성 확인
      fetch('https://backend-beta-lemon.vercel.app/verifyToken', {
        method: 'POST',
        headers: {
          'Authorization': Bearer ${token}, // 토큰 전송
          'Content-Type': 'application/json'
        }
      })
        .then(response => response.json())
        .then(data => {
          if (!data.success) {
            alert('Session expired. Please log in again.');
            localStorage.removeItem('token'); // 유효하지 않은 토큰 삭제
            window.location.href = 'index.html';
          }
        })
        .catch(() => {
          alert('Error verifying token. Redirecting to login page.');
          localStorage.removeItem('token');
          window.location.href = 'index.html';
        });
    }

    // 페이지 로드 시 토큰 확인
    verifyToken();

    // 지도 초기화
    var map = L.map('map').setView([33.0, -83.5], 7);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    var markers = []; // 마커를 저장할 배열
    var minZoomForMarkers = 7; // 마커 표시 최소 줌 레벨

    // JSON 데이터 로드
    fetch('./location.json')
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to fetch JSON');
        }
        return response.json();
      })
      .then(locations => {
        console.log('Loaded locations:', locations); // JSON 데이터 확인
        locations.forEach(location => {
          // Leaflet Awesome Marker 설정
          var customIcon = L.AwesomeMarkers.icon({
            extraClasses: 'fa-rotate-0',
            icon: 'info-sign',
            iconColor: 'white',
            markerColor: 'red',
            prefix: 'glyphicon'
          });

          var marker = L.marker([location.lat, location.lng], {icon: customIcon});

          if (location.SOSlink) {
            marker.bindPopup(
              ${location.name}<br>
              <a href="javascript:void(0)" onclick="navigateTo('${location.SOSlink}')" style="text-decoration: none; color: blue;">SOS</a>
            );
          } else {
            marker.bindPopup(location.name);
          }

          markers.push(marker); // 마커를 배열에 저장
        });

        updateMarkers(); // 초기 상태에서 마커 업데이트
      })
      .catch(error => console.error('Error loading JSON:', error));

    // 마커 표시 상태 업데이트
    function updateMarkers() {
      var currentZoom = map.getZoom(); // 현재 줌 레벨
      markers.forEach(marker => {
        if (currentZoom >= minZoomForMarkers) {
          if (!map.hasLayer(marker)) map.addLayer(marker); // 마커 추가
        } else {
          if (map.hasLayer(marker)) map.removeLayer(marker); // 마커 제거
        }
      });
    }

    // 줌 이벤트 핸들러
    map.on('zoomend', updateMarkers);

    // 지도 클릭 시 검색 결과 숨김
    map.on('click', function() {
      document.getElementById('results').innerHTML = '';
    });

    // 페이지 이동 함수
    function navigateTo(link) {
      window.location.assign(link); // 현재 창에서 이동
    }

    // Nominatim API로 검색 기능 추가
    document.getElementById('search-button').addEventListener('click', performSearch);
    document.getElementById('search-input').addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        performSearch();
      }
    });

    function performSearch() {
      var query = document.getElementById('search-input').value;
      if (!query) {
        alert('Please enter a location to search.');
        return;
      }

      var url = https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)};
      fetch(url)
        .then(response => response.json())
        .then(results => {
          if (results.length > 0) {
            handleSearchResults(results); // 검색 결과 목록 표시
          } else {
            alert('Location not found.');
          }
        })
        .catch(error => console.error('Error with Nominatim API:', error));
    }

    // 검색 결과 표시 함수
    function handleSearchResults(data) {
      const resultsContainer = document.getElementById('results');
      resultsContainer.innerHTML = '';

      data.forEach(result => {
        const resultElement = document.createElement('div');
        resultElement.textContent = result.display_name;
        resultElement.onclick = () => moveToLocation(result.lat, result.lon);
        resultsContainer.appendChild(resultElement);
      });
    }

    function moveToLocation(lat, lon) {
      map.setView([lat, lon], 12); // 줌 레벨 12
    }
  </script>
</body>
</html>
