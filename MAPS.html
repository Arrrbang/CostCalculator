<!DOCTYPE html>
<html>
<head>
  <title>Leaflet MAPS</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    html, body {width: 100%; height: 100%; margin: 0; padding: 0;}
    #map {position: absolute; top: 0; bottom: 0; right: 0; left: 0; height: 100%;}
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    // 지도 초기화
    var map = L.map('map').setView([33.0, -83.5], 7);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    var markers = []; // 마커를 저장할 배열
    var minZoomForMarkers = 10; // 마커 표시 최소 줌 레벨

    // JSON 데이터 로드
    fetch('./locations.json') // JSON 경로
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to fetch JSON');
        }
        return response.json();
      })
      .then(locations => {
        locations.forEach(location => {
          var customIcon = L.AwesomeMarkers.icon({
            extraClasses: 'fa-rotate-0',
            icon: 'info-sign',
            iconColor: 'white',
            markerColor: 'red',
            prefix: 'glyphicon'
          });

          var marker = L.marker([location.lat, location.lng], {icon: customIcon});

          if (location.SOSlink) {
            marker.bindPopup(
              `${location.name}<br>
              <a href="javascript:void(0)" onclick="navigateTo('${location.SOSlink}')" style="text-decoration: none; color: blue;">SOS</a>`
            );
          } else {
            marker.bindPopup(location.name);
          }

          markers.push(marker); // 배열에 마커 저장
        });

        updateMarkers(); // 초기 상태에서 마커 가시성 업데이트
      })
      .catch(error => console.error('Error loading JSON:', error));

    // 마커 표시 상태 업데이트
    function updateMarkers() {
      var currentZoom = map.getZoom(); // 현재 줌 레벨
      markers.forEach(marker => {
        if (currentZoom >= minZoomForMarkers) {
          if (!map.hasLayer(marker)) map.addLayer(marker); // 마커 추가
        } else {
          if (map.hasLayer(marker)) map.removeLayer(marker); // 마커 제거
        }
      });
    }

    // 줌 이벤트 핸들러
    map.on('zoomend', updateMarkers);

    // 페이지 이동 함수
    function navigateTo(link) {
      window.location.assign(link); // 현재 창에서 이동
    }

    // 검색 컨트롤 추가 및 항상 열려 있게 설정
    var geocoder = L.Control.geocoder({
      defaultMarkGeocode: false
    }).addTo(map);

    geocoder._toggle(); // 검색 바를 항상 확장된 상태로 유지

    geocoder.on('markgeocode', function(e) {
      var bbox = e.geocode.bbox;
      var poly = L.polygon([
        bbox.getSouthEast(),
        bbox.getNorthEast(),
        bbox.getNorthWest(),
        bbox.getSouthWest()
      ]).addTo(map);
      map.fitBounds(poly.getBounds());
    });
  </script>
</body>
</html>

