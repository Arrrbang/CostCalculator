<!DOCTYPE html>
<html>
<head>
  <title>í“¨ë©•ìŠ¤ í˜„ì§€ë¹„ìš© ê³„ì‚°ê¸° beta</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.css" />
  <!-- Leaflet Awesome Markers CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" />
  <!-- Bootstrap CSS for Glyphicons -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <!-- Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.js"></script>
  <!-- Leaflet Awesome Markers JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />

  <style>
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
    }

    #logo {
      position: relative; /* ì •ì  ìœ„ì¹˜ */
      margin-left: 10px; /* ì™¼ìª½ ë§ˆì§„ */
      margin-top: 20px; /* ìƒë‹¨ ë§ˆì§„ */
      width: 150px; /* ì´ë¯¸ì§€ ë„ˆë¹„ */
      margin-bottom: 30px; 
    }

    #map {
      flex: 1;
      height: auto;
    }
    #search-container {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      border-radius: 5px;
      z-index: 1000;
      display: flex;
      gap: 5px;
    }
    #search-input {
      width: 200px;
      padding: 5px;
    }
    #results {
      position: absolute;
      top: 50px;
      right: 0px;
      background: white;
      width: 220px;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      border-radius: 5px;
      z-index: 1000;
    }
    #results div {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
    }
    #results div:hover {
      background: #f0f0f0;
    }

     input[type="text"], input[type="search"] {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      font-size: 16px;
    }

    .leaflet-popup-content {
      white-space: nowrap; /* í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
      text-align: center;
    }

      .leaflet-popup-content strong {
        font-weight: bold; /* êµµê²Œ í‘œì‹œ */
        font-size: 1.2em; /* ë³¼ë“œ í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì • (ì„ íƒ ì‚¬í•­) */
      }

      .leaflet-div-icon {
        background: transparent !important; /* ë°°ê²½ì„ íˆ¬ëª…í•˜ê²Œ */
        border: none !important; /* í…Œë‘ë¦¬ ì œê±° */
        box-shadow: none !important; /* ê·¸ë¦¼ì ì œê±° */
      }

@media (max-width: 480px) {
  #map {
    height: calc(100vh - 10%); /* ì§€ë„ë¥¼ ì „ì²´ í™”ë©´ì— ê°€ê¹ê²Œ í™•ì¥ */
  }

  .leaflet-popup-content {
    font-size: 1.5rem; /* íŒì—… í…ìŠ¤íŠ¸ í¬ê¸° ë” í¬ê²Œ */
    max-width: 350px; /* íŒì—… ìµœëŒ€ ë„ˆë¹„ ë” í™•ëŒ€ */
  }

  .leaflet-popup-tip {
    width: 15px; /* íŒì—… í™”ì‚´í‘œ í¬ê¸° ë” í™•ëŒ€ */
    height: 15px;
  }

  .leaflet-marker-icon {
    transform: scale(2); /* ë§ˆì»¤ í¬ê¸° ë” í™•ëŒ€ */
    width: auto; /* ìë™ í¬ê¸° ì„¤ì • */
    height: auto; /* ìë™ í¬ê¸° ì„¤ì • */
  }

  .leaflet-marker-shadow {
    transform: scale(2); /* ë§ˆì»¤ ê·¸ë¦¼ì í¬ê¸° ë” í™•ëŒ€ */
  }

  /* ê²€ìƒ‰ì°½ ìŠ¤íƒ€ì¼ */
  #search-container {
    top: 15px; /* ìƒë‹¨ ê°„ê²© */
    right: 10px; /* ìš°ì¸¡ ê°„ê²© */
    padding: 15px; /* ë‚´ë¶€ ì—¬ë°± ì¦ê°€ */
    gap: 10px; /* ì…ë ¥ í•„ë“œì™€ ë²„íŠ¼ ê°„ ê°„ê²© ì¦ê°€ */
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.3); /* ê·¸ë¦¼ì ê°•ì¡° */
  }

  #search-input {
    width: 250px; /* ê²€ìƒ‰ì°½ ë„ˆë¹„ í™•ëŒ€ */
    font-size: 1.2rem; /* ê¸€ì”¨ í¬ê¸° í™•ëŒ€ */
    padding: 10px; /* ì…ë ¥ í•„ë“œ ë‚´ë¶€ ì—¬ë°± ì¦ê°€ */
  }

  #search-button {
    font-size: 1.2rem; /* ë²„íŠ¼ í…ìŠ¤íŠ¸ í¬ê¸° í™•ëŒ€ */
    padding: 10px 15px; /* ë²„íŠ¼ ë‚´ë¶€ ì—¬ë°± ì¦ê°€ */
  }
}

  </style>
</head>
<body>
  <a href="../selectpage.html">
    <img id="logo" src="https://arrrbang.github.io/CostCalculator/image/pumexlogonew.png" alt="Logo">
  </a>
  <div id="search-container">
    <input type="text" id="search-input" placeholder="Search for a location" />
    <button id="search-button">Search</button>
  </div>
  <div id="results"></div>
  <div id="map"></div>

  <script>
    // ì¸ì¦ í™•ì¸: í† í° ê²€ì¦
    function verifyToken() {
      const token = localStorage.getItem('token'); // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í† í° ê°€ì ¸ì˜¤ê¸°
      if (!token) {
        alert('ë¡œê·¸ì¸ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        window.location.href = '/CostCalculator/index.html'; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜
        return;
      }

      // í† í° ìœ íš¨ì„± í™•ì¸
      fetch('https://backend-beta-lemon.vercel.app/verifyToken', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`, // í† í° ì „ì†¡
          'Content-Type': 'application/json'
        }
      })
        .then(response => response.json())
        .then(data => {
          if (!data.success) {
            alert('Session expired. Please log in again.');
            localStorage.removeItem('token'); // ìœ íš¨í•˜ì§€ ì•Šì€ í† í° ì‚­ì œ
            window.location.href = '/CostCalculator/index.html';
          }
        })
        .catch(() => {
          alert('Error verifying token. Redirecting to login page.');
          localStorage.removeItem('token');
          window.location.href = '/CostCalculator/index.html';
        });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í† í° í™•ì¸
    verifyToken();

// ì§€ë„ ì´ˆê¸°í™” (ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ ë§ˆì»¤ í‘œì‹œ ì„¤ì •)
var map = L.map('map', {
  minZoom: 1,  // ìµœì†Œ ì¤Œì€ ì„¤ì •í•˜ì§€ ì•ŠìŒ
  maxBounds: [
    [-90, -180], // ë‚¨ìª½ê³¼ ì„œìª½ ê²½ê³„
    [90, 180]    // ë¶ìª½ê³¼ ë™ìª½ ê²½ê³„
  ], // ì§€ë„ ì´ë™ ë²”ìœ„ë¥¼ ì§€êµ¬ ì „ì²´ë¡œ ì œí•œ
  worldCopyJump: true // ì„¸ê³„ ì „ì—­ì„ ë„˜ì§€ ì•Šë„ë¡ ì„¤ì •
}).setView([33.0, -83.5], 6);  // ê¸°ë³¸ ì¤Œ ë ˆë²¨ì€ 7ë¡œ ì„¤ì •

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

var markers = []; // ë§ˆì»¤ë¥¼ ì €ì¥í•  ë°°ì—´
var minZoomForMarkersWeb = 6; // ì›¹ì—ì„œëŠ” 6 ì´ìƒì—ì„œë§Œ ë§ˆì»¤ í‘œì‹œ
var minZoomForMarkersMobile = 5; // ëª¨ë°”ì¼ì—ì„œëŠ” 5 ì´ìƒì—ì„œë§Œ ë§ˆì»¤ í‘œì‹œ

// ë§ˆì»¤ í‘œì‹œ ì—¬ë¶€ë¥¼ ì œì–´í•˜ëŠ” í•¨ìˆ˜
function updateMarkers() {
  var currentZoom = map.getZoom(); // í˜„ì¬ ì¤Œ ë ˆë²¨
  var isMobile = window.innerWidth <= 480; // ëª¨ë°”ì¼ í™”ë©´ ì—¬ë¶€ í™•ì¸
  var minZoomForMarkers = isMobile ? minZoomForMarkersMobile : minZoomForMarkersWeb;

  markers.forEach(marker => {
    if (currentZoom >= minZoomForMarkers) {
      if (!map.hasLayer(marker)) map.addLayer(marker); // ë§ˆì»¤ ì¶”ê°€
    } else {
      if (map.hasLayer(marker)) map.removeLayer(marker); // ë§ˆì»¤ ì œê±°
    }
  });
}

// JSON ë°ì´í„° ë¡œë“œ í›„ ë§ˆì»¤ ìƒì„± ë° ì´ˆê¸°í™”
fetch('./location.json')
  .then(response => {

    if (!response.ok) {
      throw new Error('Failed to fetch JSON');
    }
    return response.json();
  })
  .then(locations => {
    console.log('Loaded locations:', locations); // JSON ë°ì´í„° í™•ì¸

    locations.forEach(location => {
      if (!location.links || !Array.isArray(location.links)) {
        console.warn('Links are missing or not an array for location:', location.name);


        return;
      }

      const linksHTML = location.links
        .map(
          (link) =>
            `<a href="../home.html?path=${encodeURIComponent(
              link.path
            )}" style="color: ${link.color || "blue"};">${link.type || "View Details"}</a>`
        )
        .join("<br>");

      const popupContent = `<strong>${location.name}</strong><br>${linksHTML}`;

      const customIcon = L.AwesomeMarkers.icon({
        extraClasses: 'fa-rotate-0',
        icon: 'info-sign',
        iconColor: 'white',
        markerColor: 'red',
        prefix: 'glyphicon'
      });

      const marker = L.marker([location.lat, location.lng], { icon: customIcon });
      marker.bindPopup(popupContent);
      markers.push(marker);
    });

    updateMarkers();
  })
  .catch(error => console.error('Error loading JSON:', error));


// ì¤Œ ë ˆë²¨ ë³€ê²½ ì‹œ ë§ˆì»¤ ìƒíƒœ ì—…ë°ì´íŠ¸
map.on('zoomend', updateMarkers);

// ì§€ë„ í´ë¦­ ì‹œ ê²€ìƒ‰ ê²°ê³¼ ìˆ¨ê¹€
map.on('click', function() {
  document.getElementById('results').innerHTML = '';
});

// ì¤Œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ - íŒì—… í¬ê¸° ì—…ë°ì´íŠ¸
map.on('zoomend', () => {
  const currentZoom = map.getZoom();
  markers.forEach(marker => {
    const popup = marker.getPopup();
    if (popup.isOpen()) {
      resizePopup(popup, currentZoom);
    }
  });
});

// íŒì—… í¬ê¸°ë¥¼ ë™ì ìœ¼ë¡œ ë³€ê²½í•˜ëŠ” í•¨ìˆ˜
function resizePopup(popup, zoomLevel) {
  const baseSize = 150; // ê¸°ë³¸ íŒì—… í¬ê¸°
  const scaleFactor = 20; // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í¬ê¸° ì¦ê°€ëŸ‰
  const newWidth = baseSize + (zoomLevel - minZoomForMarkersWeb) * scaleFactor;

  popup.getElement().style.width = `${newWidth}px`;
  popup.getElement().style.fontSize = `${14 + (zoomLevel - minZoomForMarkersWeb)}px`; // í°íŠ¸ í¬ê¸° ì¦ê°€
}

// í˜ì´ì§€ ì´ë™ í•¨ìˆ˜
function navigateTo(link) {
  window.location.assign(link); // í˜„ì¬ ì°½ì—ì„œ ì´ë™
}


    // Nominatim APIë¡œ ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€
    document.getElementById('search-button').addEventListener('click', performSearch);
    document.getElementById('search-input').addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        performSearch();
      }
    });

    function performSearch() {
      var query = document.getElementById('search-input').value;
      if (!query) {
        alert('Please enter a location to search.');
        return;
      }

      var url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;
      fetch(url)
        .then(response => response.json())
        .then(results => {
          if (results.length > 0) {
            handleSearchResults(results); // ê²€ìƒ‰ ê²°ê³¼ ëª©ë¡ í‘œì‹œ
          } else {
            alert('Location not found.');
          }
        })
        .catch(error => console.error('Error with Nominatim API:', error));
    }

    // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
function handleSearchResults(data) {
  const resultsContainer = document.getElementById('results');
  resultsContainer.innerHTML = '';

  data.forEach(result => {
    const resultElement = document.createElement('div');
    resultElement.textContent = result.display_name;
    resultElement.onclick = () => moveToLocation(result.lat, result.lon);
    resultsContainer.appendChild(resultElement);

    // ë…¸ë€ìƒ‰ ë§ˆì»¤ ì•„ì´ì½˜ ìƒì„±
    const yellowCustomIcon = L.divIcon({
      html: '<div style="background: #FFD700; border-radius: 50%; width: 30px; height: 30px; text-align: center; color: white; line-height: 30px;">ğŸ”</div>',
      iconSize: [30, 30],
      iconAnchor: [15, 30],
      popupAnchor: [0, -30]
    });

    const marker = L.marker([result.lat, result.lon], { icon: yellowCustomIcon });
    // ë§ˆì»¤ z-indexë¥¼ ì¡°ì •í•˜ì—¬ ê¸°ì¡´ ë§ˆì»¤ ë’¤ë¡œ ë°°ì¹˜
    marker.setZIndexOffset(-1); // z-indexë¥¼ -1ë¡œ ì„¤ì •í•˜ì—¬ ê¸°ì¡´ ë§ˆì»¤ ë’¤ì— ë°°ì¹˜
    marker.addTo(map); // ì§€ë„ì— ë§ˆì»¤ ì¶”ê°€
  });
}

    function moveToLocation(lat, lon) {
      map.setView([lat, lon], 12); // ì¤Œ ë ˆë²¨ 12
    }
  </script>
</body>
</html>
